---
import type { SiteData } from '../types/site';
import { resolveTheme, getThemeById } from '../lib/themes';
import CenteredLayout from './layouts/CenteredLayout.astro';
import SplitLayout from './layouts/SplitLayout.astro';
import MinimalLayout from './layouts/MinimalLayout.astro';

interface BizData {
  title: string;
  phone: string;
  address: string;
  category: string;
  gps_lat: number;
  gps_lng: number;
  rating: number | null;
}

interface Props {
  site: SiteData;
  biz: BizData | null;
  slug: string;
}

const { site, biz, slug } = Astro.props;

const category = biz?.category ?? '';
const themeConfig = site.theme
  ? { id: site.theme, colors: getThemeById(site.theme)!, layout: resolveTheme(slug, category).layout }
  : resolveTheme(slug, category);
const { colors, layout } = themeConfig;

const jsonLd = biz ? JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'LocalBusiness',
  name: biz.title,
  telephone: biz.phone,
  address: { '@type': 'PostalAddress', streetAddress: biz.address, addressCountry: 'PL' },
  geo: { '@type': 'GeoCoordinates', latitude: biz.gps_lat, longitude: biz.gps_lng },
  ...(biz.rating ? { aggregateRating: { '@type': 'AggregateRating', ratingValue: biz.rating, bestRating: 5 } } : {}),
  url: Astro.url.href,
}) : null;

const locSlug = Astro.url.pathname.split('/').filter(Boolean)[0] ?? '';
const locName = biz?.address?.split(',').pop()?.trim() ?? locSlug;

const breadcrumbLd = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Strona główna', item: 'https://wizytowka.link/' },
    { '@type': 'ListItem', position: 2, name: locName, item: `https://wizytowka.link/${locSlug}/` },
    { '@type': 'ListItem', position: 3, name: site.seo.title },
  ],
});
---

<!DOCTYPE html>
<html lang="pl" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{site.seo.title}</title>
  <meta name="description" content={site.seo.description} />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href={Astro.url.href} />

  <meta property="og:title" content={site.seo.title} />
  <meta property="og:description" content={site.seo.description} />
  <meta property="og:type" content="website" />
  <meta property="og:url" content={Astro.url.href} />
  <meta property="og:locale" content="pl_PL" />
  <meta name="twitter:card" content="summary" />

  {jsonLd && <script type="application/ld+json" set:html={jsonLd} />}
  <script type="application/ld+json" set:html={breadcrumbLd} />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
</head>

<body class="text-gray-900 font-sans antialiased">
<main>
{layout === 'centered' ? <CenteredLayout site={site} theme={colors} />
: layout === 'split' ? <SplitLayout site={site} theme={colors} />
: <MinimalLayout site={site} theme={colors} />}
</main>
</body>
</html>

---
import BusinessSite from '../../components/BusinessSite.astro';
import type { SiteData } from '../../types/site';

const { loc, slug } = Astro.params;

if (!loc || !slug) return new Response(null, { status: 404 });

const r2 = Astro.locals.runtime.env.sites as R2Bucket;
const db = Astro.locals.runtime.env.leadgen as D1Database;
const obj = await r2.get(`sites/${loc}/${slug}.json`);

if (!obj) return new Response('Not Found', { status: 404 });

const site = (await obj.json()) as SiteData;

// business data for JSON-LD
const biz = await db.prepare(`
  SELECT b.title, b.phone, b.address, b.category, b.gps_lat, b.gps_lng, b.rating
  FROM businesses b
  JOIN localities l ON b.locality_id = l.id
  WHERE l.slug = ? AND b.slug = ?
`).bind(loc, slug).first<{
  title: string; phone: string; address: string; category: string;
  gps_lat: number; gps_lng: number; rating: number | null;
}>();

// 7d edge cache. Purge on regeneration: pnpm wrangler r2 object delete + CF cache purge API
// POST https://api.cloudflare.com/client/v4/zones/{zone_id}/purge_cache {"files":["url"]}
Astro.response.headers.set('Cache-Control', 'public, max-age=86400, s-maxage=604800');
---

<BusinessSite site={site} biz={biz} slug={slug} />

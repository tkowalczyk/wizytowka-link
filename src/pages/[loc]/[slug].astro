---
import BusinessSite from '../../components/BusinessSite.astro';
import type { SiteData } from '../../types/site';

const { loc, slug } = Astro.params;

if (!loc || !slug) return new Response(null, { status: 404 });

const r2 = Astro.locals.runtime.env.sites as R2Bucket;
const db = Astro.locals.runtime.env.leadgen as D1Database;

const isDraft = Astro.url.searchParams.get('draft') === '1';
const r2Key = isDraft
  ? `sites/draft/${loc}/${slug}.json`
  : `sites/${loc}/${slug}.json`;

const obj = await r2.get(r2Key);

if (!obj) return new Response('Not Found', { status: 404 });

const site = (await obj.json()) as SiteData;

const biz = await db.prepare(`
  SELECT b.title, b.phone, b.address, b.category, b.gps_lat, b.gps_lng, b.rating
  FROM businesses b
  JOIN localities l ON b.locality_id = l.id
  WHERE l.slug = ? AND b.slug = ?
`).bind(loc, slug).first<{
  title: string; phone: string; address: string; category: string;
  gps_lat: number; gps_lng: number; rating: number | null;
}>();

if (isDraft) {
  Astro.response.headers.set('Cache-Control', 'no-store');
} else {
  Astro.response.headers.set('Cache-Control', 'public, max-age=86400, s-maxage=604800');
}
---

{isDraft && (
  <div style="background:#f59e0b;color:#000;text-align:center;padding:12px;font-weight:bold;position:fixed;top:0;left:0;right:0;z-index:9999;">
    PODGLAD â€” ta wersja nie jest jeszcze opublikowana
  </div>
)}

<BusinessSite site={site} biz={biz} slug={slug} />
